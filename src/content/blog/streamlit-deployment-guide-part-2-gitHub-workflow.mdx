---
heroImage: /src/assets/images/bg.jpg
category: CICD
description: >-
  Configure a GitHub workflow to build the Dockerfile and publish the image to
  ghcr.io
pubDate: 2024-06-17T22:00:00.000Z
draft: true
tags:
  - github actions
  - github
  - docker
title: >-
  Streamlit Deployment Guide Part 2: GitHub Workflow to Build/Publish
  to ghcr.io
---

This showcases a Github workflow walkthrough of building and publishing a Docker image to GitHub Container Registry. It continues a series detailing the process of deploying Streamlit app to Azure, broken down into the following parts:

- **Part 1**: Containerizing a Streamlit app.
- **Part 2**: GitHub Workflow for Building and Publishing to ghcr.io **You are here** ðŸ˜Š
- **Part 3**: Azure Infrastructure via Terraform
- **Part 4**: GitHub Workflow for Terraform Apply & Destroy

Do you want to deploy your Streamlit application on Azure right now? Use the [template repository](https://github.com/WayneGoosen/azure-streamlit-poc) ðŸš€

## TL;DR

Read the [completed GitHub workflow](#completed-workflow).

## Create a GitHub Workflow

### Completed Workflow

```yaml
name: Docker Image Build and Push

on:
  push:
    branches: ['main']
    paths:
      - 'app/**'
  workflow_dispatch:

# If this workflow is triggered again while a previous run is still in progress, GitHub will queue the new run until the previous one completes.
concurrency:
  group: build-and-push-image

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io

    permissions:
      contents: write
      packages: write

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # image name needs to be lowercase, some accounts have uppercase letters
      - name: Get owner/repo name and convert to lowercase
        id: get-image-name
        run: echo "image-name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # Install GitVersion for versioning
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1.1.1
        with:
          versionSpec: '5.x'

      # Execute GitVersion to get the version number
      - name: Use GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1.1.1

      # Set up Git user for tagging
      - uses: fregante/setup-git-user@v2

      # Create a new tag based on the version number
      - name: Create Tag
        run: git tag -a ${{ steps.gitversion.outputs.semVer }} -m "Auto-generated tag from GitHub Action."

      # Push the newly created tags to the repository
      - name: Push Tags
        run: git push origin --tags

      # Log in to the Container registry
      - name: Log in to the Container registry
        uses: docker/login-action@v3.2.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build and push the Docker image to the registry
      - name: Build and push Docker image
        uses: docker/build-push-action@v5.3.0
        with:
          context: ./app
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.get-image-name.outputs.image-name }}:latest
            ${{ env.REGISTRY }}/${{ steps.get-image-name.outputs.image-name }}:${{ steps.gitversion.outputs.semVer }}
```

### Workflow walkthrough

#### Workflow Definition

```
name: Docker Image Build and Push
```

This is the name of the GitHub Actions workflow.

#### Triggers

```on:
  push:
    branches: [ "main" ]
    paths:
      - 'app/**'
  workflow_dispatch:
```

The workflow triggers on pushes to the "main" branch.
The workflow triggers only if changes are made to files in the 'app' directory.
workflow_dispatch Allows the workflow to be triggered manually.

#### Concurrency

```
currency:
- group: build-and-push-image
```

Ensures that if the workflow is triggered again while a previous run is in progress, the new run will queue until the previous one completes.

#### Jobs

```
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io
```

Specifies that the job runs on the latest version of Ubuntu.
REGISTRY: ghcr.io Sets an environment variable for the container registry.

```
 permissions:
      contents: write
      packages: write
```

Grants the necessary permissions for the job to interact with the repository contents and packages.

#### Steps

##### 1. Checkout the Repository

```
- name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
```

Checks out the repository to the runner.

##### 2. Get Owner/Repo Name and Convert to Lowercase

```
 - name: Get owner/repo name and convert to lowercase
        id: get-image-name
        run: echo "image-name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
```

Retrieves the repository name and converts it to lowercase for use as the Docker image name.

##### 3. Install GitVersion for Versioning

```
- name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1.1.1
        with:
          versionSpec: '5.x'
```

Installs GitVersion tool for semantic versioning.

##### 4. Execute GitVersion to Get the Version Number

```
- name: Use GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1.1.1
```

Runs GitVersion to generate the semantic version number.

##### 5. Set Up Git User for Tagging

```
- uses: fregante/setup-git-user@v2
```

Sets up Git user for tagging purposes.

##### 6. Create a New Tag Based on the Version Number

```
- name: Create Tag
        run: git tag -a ${{ steps.gitversion.outputs.semVer }} -m "Auto-generated tag from GitHub Action."
```

Creates a new Git tag based on the version number generated by GitVersion.

##### 7. Push the Newly Created Tags to the Repository

```
 - name: Push Tags
        run: git push origin --tags
```

- Pushes the created tags to the GitHub repository.

##### 8. Log in to the Container Registry

```
- name: Log in to the Container registry
        uses: docker/login-action@v3.2.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
```

Logs in to the container registry using the GitHub actor and token.

##### 9. Build and Push the Docker Image to the Registry

```
- name: Build and push Docker image
        uses: docker/build-push-action@v5.3.0
        with:
          context: ./app
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.get-image-name.outputs.image-name }}:latest
            ${{ env.REGISTRY }}/${{ steps.get-image-name.outputs.image-name }}:${{ steps.gitversion.outputs.semVer }}
```

Builds and pushes the Docker image to the specified registry with the appropriate tags. The context is set to the 'app' directory, and the image is tagged with both 'latest' and the semantic version.

## What is gitversion?

GitVersion is a tool that helps automate versioning of software projects based on Git commit history, providing a consistent and reliable way to generate version numbers for different branches and releases. [Read the documentation](https://gitversion.net/docs/)

### gitversion Configuration

The provided gitversion file contains configuration settings for the GitVersion tool, which is used to generate a version for our Docker image. It specifies the versioning scheme, commit message patterns for incrementing versions, fallback tags, and other options related to continuous delivery and versioning.

The main point is that it uses the [conventional commits](https://www.conventionalcommits.org/en/v1.0.0/) specification to create the version number.

#### Configuration file

```yaml
assembly-versioning-scheme: MajorMinorPatch
assembly-file-versioning-scheme: MajorMinorPatch
assembly-informational-format: '{InformationalVersion}'
mode: ContinuousDelivery
increment: Inherit
continuous-delivery-fallback-tag: ci
tag-prefix: '[vV]'
major-version-bump-message: "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\\([\\w\\s-]*\\))?(!:|:.*\\n\\n((.+\\n)+\\n)?BREAKING CHANGE:\\s.+)"
minor-version-bump-message: "^(feat)(\\([\\w\\s-]*\\))?:"
patch-version-bump-message: "^(build|chore|ci|docs|fix|perf|refactor|revert|style|test)(\\([\\w\\s-]*\\))?:"
no-bump-message: '\+semver:\s?(none|skip)'
commit-message-incrementing: Enabled
merge-message-formats: {}
update-build-number: true
```
